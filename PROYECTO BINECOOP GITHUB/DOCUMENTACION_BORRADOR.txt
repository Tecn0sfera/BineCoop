BORRADOR DE DOCUMENTACIÓN - SISTEMA DE GESTIÓN COOPERATIVA BINECOOP
=====================================================================

ARQUITECTURA GENERAL DEL PROYECTO
---------------------------------

El sistema BineCoop es una aplicación web de gestión integral para cooperativas de vivienda, desarrollada en PHP con arquitectura de dos sitios web independientes pero interconectados que comparten una base de datos MySQL centralizada. La arquitectura se divide en dos componentes principales: htdocscop (sitio para trabajadores y socios) y htdocspanel (panel de administración), ambos diseñados para operar en entornos de hosting compartido con restricciones de seguridad como open_basedir, lo que requiere soluciones específicas para el intercambio de archivos y datos entre ambos sistemas. El proyecto utiliza una estructura modular con separación de responsabilidades, donde cada sitio mantiene su propia configuración, autenticación y lógica de negocio, pero comparte la misma base de datos para garantizar la consistencia de la información. La comunicación entre ambos sistemas se realiza principalmente a través de la base de datos compartida y, cuando es necesario, mediante endpoints API específicos que actúan como proxies para el intercambio de recursos como archivos PDF, evitando así las restricciones de seguridad del servidor.

GESTIÓN DE COMPROBANTES DE PAGO
--------------------------------

El sistema de comprobantes de pago representa uno de los módulos más complejos del proyecto, implementando un flujo completo desde la subida de archivos PDF por parte de los trabajadores hasta su aprobación o rechazo por parte de los administradores. Los comprobantes se almacenan en una tabla dedicada de la base de datos (comprobantes_pago) que incluye campos para el trabajador asociado, título, descripción, nombre y ruta del archivo, tamaño, fecha de envío, estado (pendiente, aprobado, rechazado), fechas de aprobación y rechazo, identificadores de los administradores que procesaron el comprobante, y razones de rechazo cuando aplica. Los archivos PDF físicos se guardan en el sistema de archivos del servidor dentro del directorio htdocscop/uploads/reports/, utilizando nombres únicos generados con timestamps y identificadores únicos para evitar colisiones. Cuando un trabajador sube un comprobante desde htdocscop, el sistema valida el archivo (tipo MIME, tamaño máximo de 10MB, nombre válido), lo mueve al directorio de almacenamiento, y crea un registro en la base de datos con estado "pendiente". Los administradores desde htdocspanel pueden visualizar todos los comprobantes pendientes, descargar los PDFs para revisión, y aprobar o rechazar cada uno, actualizando el estado en la base de datos y registrando la información del procesamiento. Debido a las restricciones de open_basedir que impiden que htdocspanel acceda directamente a los archivos almacenados en el volumen de htdocscop, se implementó un sistema de proxy mediante el endpoint serve_pdf.php en htdocscop, que permite a htdocspanel solicitar la descarga de archivos a través de redirecciones HTTP, resolviendo así las limitaciones de seguridad del entorno de hosting compartido.

GESTIÓN DE SOCIOS Y VIVIENDAS
-------------------------------

El sistema gestiona una estructura compleja de socios (miembros de la cooperativa), visitantes (solicitantes en proceso de aprobación), y viviendas (departamentos y casas disponibles para asignación). La tabla de visitantes almacena información de personas que solicitan ingresar a la cooperativa, con estados de aprobación (pendiente, aprobado, rechazado) y datos personales básicos. Una vez aprobado, un visitante puede convertirse en socio mediante la tabla socios, que mantiene una relación con visitantes mediante visitante_id, y almacena información adicional como CI (cédula de identidad), teléfono, apellido, fecha de ingreso, y referencias a viviendas asignadas. La tabla viviendas almacena el inventario completo de propiedades disponibles, diferenciando entre departamentos (ubicados en edificios con números y bloques) y casas (propiedades independientes), cada una con información sobre metros cuadrados, estado (libre, ocupada, en mantenimiento), y descripciones detalladas. El sistema permite a los administradores asignar viviendas a socios, registrando el tipo de asignación (casa o departamento) y manteniendo un historial de las asignaciones realizadas. La interfaz de administración proporciona vistas especializadas para el inventario de viviendas, mostrando separadamente los departamentos y las casas, con funcionalidades para agregar nuevas propiedades, actualizar estados, y gestionar las asignaciones existentes.

SISTEMA DE AUTENTICACIÓN Y SESIONES
------------------------------------

Cada sitio (htdocscop y htdocspanel) implementa su propio sistema de autenticación independiente, utilizando sesiones PHP para mantener el estado de los usuarios autenticados. El sistema de htdocscop está diseñado para trabajadores y socios, permitiendo el acceso mediante credenciales almacenadas en la tabla visitantes, con validación de estado de aprobación para asegurar que solo usuarios aprobados puedan acceder. El panel de administración (htdocspanel) utiliza un sistema de autenticación separado con roles de usuario (admin, etc.) y implementa controles de inactividad que cierran sesiones automáticamente después de 30 minutos de inactividad para mejorar la seguridad. Ambos sistemas implementan protección contra acceso directo a archivos de configuración, validación de tokens de sesión, y sanitización de datos de entrada para prevenir ataques de inyección SQL y cross-site scripting (XSS). Las sesiones se gestionan con regeneración de IDs para prevenir ataques de fijación de sesión, y se almacenan datos críticos como el ID del usuario, rol, y timestamp de última actividad para control de acceso granular a las diferentes funcionalidades del sistema.

CONFIGURACIÓN Y GESTIÓN DE VARIABLES DE ENTORNO
------------------------------------------------

El proyecto implementa un sistema sofisticado de gestión de configuración que prioriza archivos JSON sobre variables de entorno tradicionales, permitiendo una configuración centralizada y fácil de mantener. El sistema utiliza un archivo config.json en la raíz del proyecto que puede contener secciones separadas para htdocscop y htdocspanel, cada una con sus propias configuraciones de base de datos, claves API, y parámetros de aplicación. El cargador de entorno (env_loader.php) implementa una lógica de carga en cascada: primero intenta cargar desde config.json con prioridad absoluta, y si no encuentra la configuración, recurre a archivos .env tradicionales. Este enfoque permite mantener configuraciones diferentes para desarrollo y producción sin modificar código, y facilita el despliegue en diferentes entornos de hosting. Las configuraciones de base de datos incluyen host, puerto, nombre de base de datos, usuario, contraseña, y charset, mientras que las configuraciones de aplicación incluyen claves API para comunicación entre sistemas, secretos JWT para autenticación basada en tokens, y flags de entorno para controlar el nivel de logging y visualización de errores. El sistema también implementa funciones de limpieza de variables de entorno para evitar conflictos entre diferentes secciones de configuración y asegurar que cada sitio cargue únicamente sus propias configuraciones.

GESTIÓN DE TIEMPO TRABAJADO Y REPORTES
----------------------------------------

Los trabajadores pueden registrar su tiempo trabajado mediante un formulario en htdocscop que permite especificar fecha, horas trabajadas, descripción de las actividades realizadas, y opcionalmente horas de inicio y fin. Estos registros se almacenan en la tabla tiempo_trabajado con estado "pendiente" hasta que un administrador los revise y apruebe desde htdocspanel. El sistema valida que las fechas no sean futuras, que las horas sean números positivos razonables (máximo 24 horas por día, mínimo 0.25 horas), y que no existan demasiados registros duplicados para la misma fecha. Los administradores pueden visualizar todos los registros de tiempo pendientes, ver detalles de cada registro, y aprobar o rechazar individualmente o en bloque, actualizando el estado en la base de datos. El sistema también proporciona estadísticas agregadas sobre horas trabajadas, comprobantes enviados, y otros indicadores clave tanto para trabajadores individuales como para administradores que necesitan una visión general del sistema.

INTERFAZ DE USUARIO Y EXPERIENCIA
----------------------------------

Ambos sitios utilizan tecnologías modernas de frontend incluyendo Tailwind CSS para estilos, Alpine.js para interactividad del lado del cliente, y JavaScript vanilla para funcionalidades avanzadas. Las interfaces están diseñadas con un enfoque responsive que se adapta a diferentes tamaños de pantalla, utilizando componentes reutilizables y un sistema de diseño consistente. El dashboard de trabajadores en htdocscop proporciona una vista centralizada con estadísticas personales, acceso rápido a funcionalidades principales (subir comprobantes, registrar tiempo, ver historial), y notificaciones visuales mediante toasts para feedback inmediato de las acciones del usuario. El panel de administración en htdocspanel ofrece una interfaz más compleja con múltiples secciones organizadas en un sidebar navegable, incluyendo gestión de visitantes pendientes, aprobación de comprobantes, gestión de viviendas, gestión de socios, y visualización de estadísticas generales del sistema. Ambos sistemas implementan validación de formularios tanto del lado del cliente (JavaScript) como del servidor (PHP), mensajes de error descriptivos, y estados de carga visuales durante operaciones asíncronas para mejorar la experiencia del usuario.

SEGURIDAD Y MEJORES PRÁCTICAS
-------------------------------

El proyecto implementa múltiples capas de seguridad incluyendo validación y sanitización de todas las entradas de usuario, uso de prepared statements para todas las consultas a la base de datos para prevenir inyección SQL, escape de salidas HTML para prevenir XSS, y protección CSRF mediante tokens en formularios críticos. Los archivos subidos se validan exhaustivamente verificando tipo MIME real (no solo extensión), tamaño máximo, y nombres de archivo seguros antes de ser almacenados. El sistema implementa control de acceso basado en roles, verificando permisos antes de permitir acciones sensibles, y registra todas las operaciones importantes en logs del servidor para auditoría. Las contraseñas se almacenan utilizando funciones de hash seguras de PHP, y las sesiones se configuran con parámetros seguros incluyendo cookies HttpOnly y SameSite para prevenir robo de sesiones. El código está estructurado para evitar exposición de información sensible en mensajes de error, y se implementan timeouts de sesión automáticos para reducir el riesgo de sesiones abandonadas. El sistema también maneja adecuadamente las restricciones de seguridad del entorno de hosting compartido, como open_basedir, mediante soluciones arquitectónicas como proxies y redirecciones en lugar de intentar acceder directamente a recursos fuera de los directorios permitidos.

INTEGRACIÓN Y COMUNICACIÓN ENTRE SISTEMAS
------------------------------------------

Aunque htdocscop y htdocspanel son sitios independientes, están diseñados para trabajar juntos como un sistema integrado mediante la base de datos compartida y endpoints API específicos. La base de datos actúa como el punto central de integración, permitiendo que ambos sistemas lean y escriban en las mismas tablas según sus permisos y roles. Cuando se requiere acceso a recursos del sistema de archivos que están fuera de las restricciones de open_basedir, se implementan endpoints proxy que permiten a un sistema solicitar recursos del otro mediante HTTP, como en el caso de la descarga de PDFs donde htdocspanel redirige a un endpoint en htdocscop que sirve el archivo. Las operaciones asíncronas se manejan mediante fetch API de JavaScript que realiza peticiones a endpoints PHP específicos (api_worker.php en htdocscop, api_admin_workers.php en htdocspanel) que procesan las acciones y devuelven respuestas JSON estructuradas. El sistema también implementa manejo robusto de errores con logging detallado, mensajes de error descriptivos para usuarios, y respuestas JSON consistentes que permiten al frontend manejar adecuadamente tanto casos de éxito como de fallo.

MANTENIMIENTO Y ESCALABILIDAD
------------------------------

El código está estructurado de manera modular con funciones reutilizables organizadas en archivos includes dedicados (comprobantes_db.php, db.php, etc.), lo que facilita el mantenimiento y la extensión del sistema. La base de datos utiliza índices apropiados en campos frecuentemente consultados para optimizar el rendimiento, y las consultas están optimizadas para evitar N+1 queries mediante el uso de JOINs cuando es necesario. El sistema está diseñado para manejar crecimiento futuro mediante estructuras de datos normalizadas, y la separación de lógica de negocio en funciones dedicadas permite agregar nuevas funcionalidades sin modificar código existente. Los scripts de diagnóstico (debug_comprobantes.php, debug_download_paths.php, etc.) facilitan la resolución de problemas en producción, y el sistema de logging extensivo permite rastrear el flujo de ejecución y identificar problemas rápidamente. La configuración centralizada mediante config.json permite ajustar parámetros sin modificar código, y la estructura de archivos organizada facilita la navegación y comprensión del proyecto tanto para desarrolladores nuevos como para mantenimiento a largo plazo.

